# Bedrock + Lambda チャットアプリケーション 要件定義書

## 1. システム概要

ChatGPTライクなチャットアプリケーションのバックエンドシステム。
AWS Bedrock（Claude 4.5 Haiku）を利用した会話型AIインターフェース。

## 2. アーキテクチャ

```
Frontend 
   ↓
API Gateway (REST API + Cognito Authorizer)
   ↓
Lambda Function (Python)
   ↓
├─ Amazon Bedrock (Claude 4.5 Haiku)
└─ DynamoDB (2テーブル)
```

## 3. 技術スタック

| コンポーネント | 技術 |
|--------------|------|
| IaC | AWS CDK (Python) |
| Lambda Runtime | Python 3.12 |
| API Gateway | REST API |
| 認証 | Amazon Cognito (ユーザー名 + パスワード) |
| データベース | DynamoDB (オンデマンド) |
| AI Model | Bedrock - Claude 4.5 Haiku |

## 4. DynamoDB設計

### 4.1 Conversationsテーブル（会話メタデータ）

```
テーブル名: Conversations
課金モード: オンデマンド

Primary Key:
  - PK: userId (String) - パーティションキー
  - SK: conversationId (String) - ソートキー

GSI: userId-updatedAt-index
  - PK: userId (String)
  - SK: updatedAt (Number) - 降順ソート用

Attributes:
  - title: String - 会話のタイトル
  - createdAt: Number - 作成日時（Unix timestamp）
  - updatedAt: Number - 更新日時（Unix timestamp）
  - messageCount: Number - メッセージ数
```

### 4.2 Messagesテーブル（メッセージ履歴）

```
テーブル名: Messages
課金モード: オンデマンド

Primary Key:
  - PK: conversationId (String) - パーティションキー
  - SK: timestamp (Number) - ソートキー（降順）

Attributes:
  - messageId: String - メッセージID（UUID）
  - role: String - "user" または "assistant"
  - content: String - メッセージ内容
  - timestamp: Number - 作成日時（Unix timestamp）
```

## 5. API設計

### 5.1 認証
- すべてのエンドポイントでCognito認証が必要
- API GatewayのCognito Authorizerを使用
- JWTトークンをAuthorizationヘッダーで送信

### 5.2 エンドポイント一覧

#### POST /chat
新規メッセージ送信とAI応答取得。conversationIdがない場合は自動的に新規会話を作成。

**Request:**
```json
{
  "conversationId": "uuid-string (optional)",
  "message": "ユーザーのメッセージ"
}
```

**Response:**
```json
{
  "conversationId": "uuid-string",
  "response": "AIの応答",
  "timestamp": 1234567890
}
```

**処理フロー:**
1. conversationIdの有無を確認
2. なければ新規conversationIdを生成し、Conversationsテーブルに保存
3. ユーザーメッセージをMessagesテーブルに保存
4. 会話履歴を取得してBedrockに送信
5. AI応答をMessagesテーブルに保存
6. ConversationsテーブルのupdatedAtとmessageCountを更新
7. レスポンスを返却

#### GET /conversations
ユーザーの会話一覧を取得（更新日時の降順）

**Query Parameters:**
```
limit: Number (optional, default: 20) - 取得件数
lastEvaluatedKey: String (optional) - ページネーション用
```

**Response:**
```json
{
  "conversations": [
    {
      "conversationId": "uuid-string",
      "title": "会話のタイトル",
      "createdAt": 1234567890,
      "updatedAt": 1234567890,
      "messageCount": 10
    }
  ],
  "lastEvaluatedKey": "next-page-key (optional)"
}
```

#### GET /conversations/{conversationId}
特定の会話のメッセージ履歴を取得

**Path Parameters:**
```
conversationId: String - 会話ID
```

**Query Parameters:**
```
limit: Number (optional, default: 50) - 取得件数
lastEvaluatedKey: String (optional) - ページネーション用
```

**Response:**
```json
{
  "conversationId": "uuid-string",
  "messages": [
    {
      "messageId": "uuid-string",
      "role": "user",
      "content": "メッセージ内容",
      "timestamp": 1234567890
    },
    {
      "messageId": "uuid-string",
      "role": "assistant",
      "content": "AI応答",
      "timestamp": 1234567891
    }
  ],
  "lastEvaluatedKey": "next-page-key (optional)"
}
```

#### DELETE /conversations/{conversationId}
会話とそれに紐づく全メッセージを削除

**Path Parameters:**
```
conversationId: String - 会話ID
```

**Response:**
```json
{
  "message": "Conversation deleted successfully",
  "conversationId": "uuid-string"
}
```

## 6. Lambda関数設計

### 6.1 構成
- **方式**: モノリシック（1つのLambda関数で全エンドポイントを処理）
- **ランタイム**: Python 3.12
- **メモリ**: 512MB（初期値、後で調整可能）
- **タイムアウト**: 30秒

### 6.2 環境変数
```
CONVERSATIONS_TABLE_NAME: Conversationsテーブル名
MESSAGES_TABLE_NAME: Messagesテーブル名
BEDROCK_MODEL_ID: anthropic.claude-4-5-haiku-v2:0
```

### 6.3 IAMポリシー
Lambda実行ロールに以下の権限を付与:
- DynamoDB: PutItem, GetItem, Query, UpdateItem, DeleteItem
- Bedrock: InvokeModel
- CloudWatch Logs: CreateLogGroup, CreateLogStream, PutLogEvents

## 7. Bedrock呼び出し仕様（Phase 1: シンプル版）

```python
{
  "modelId": "anthropic.claude-4-5-haiku-v2:0",
  "maxTokens": 2048,
  "temperature": 1.0,
  "messages": [
    # 会話履歴をすべて送信（制限なし）
    {"role": "user", "content": "..."},
    {"role": "assistant", "content": "..."},
    # ...
  ]
}
```

**制約事項:**
- システムプロンプトは設定しない（Phase 2で追加検討）
- ストリーミングレスポンスは使用しない
- 会話履歴は全件送信（トークン制限は後で対応）

## 8. Cognito設定

### 8.1 ユーザープール設定
```
- サインイン方法: ユーザー名 + パスワード
- パスワードポリシー: デフォルト（最小8文字、大小英数字）
- MFA: 無効
- セルフサインアップ: 有効
- メール検証: 有効（後で設定）
```

### 8.2 アプリクライアント
```
- 認証フロー: USER_PASSWORD_AUTH
- リフレッシュトークン有効期限: 30日
- アクセストークン有効期限: 1時間
```

## 9. エラーハンドリング（Phase 1: シンプル版）

### 9.1 基本方針
```python
try:
    # 処理
except Exception as e:
    logger.error(f"Error: {str(e)}")
    return {
        'statusCode': 500,
        'body': json.dumps({'error': 'Internal server error'})
    }
```

### 9.2 エラーレスポンス
```json
{
  "error": "エラーメッセージ",
  "code": "ERROR_CODE (optional)"
}
```

### 9.3 HTTPステータスコード
- 200: 成功
- 400: リクエストエラー
- 401: 認証エラー
- 404: リソースが見つからない
- 500: サーバーエラー

## 10. 実装フェーズ

### Phase 1: 最小構成（MVP）
1. CDKでインフラ構築
   - DynamoDB（2テーブル）
   - Lambda関数
   - API Gateway（REST API）
   - Cognito（ユーザープール）
2. Lambda関数実装
   - POST /chat のみ
   - 基本的なエラーハンドリング
3. 動作確認・デバッグ

### Phase 2: 機能拡張
4. 残りのエンドポイント実装
   - GET /conversations
   - GET /conversations/{id}
   - DELETE /conversations/{id}
5. 会話タイトル自動生成機能
6. ページネーション実装

### Phase 3: 改善・最適化
7. エラーハンドリング強化
   - リトライロジック
   - ロールバック処理
8. ロギング・モニタリング
   - CloudWatch Dashboards
   - アラーム設定
9. パフォーマンス最適化
   - Bedrock呼び出しのトークン制限
   - DynamoDBクエリ最適化
10. セキュリティ強化
    - WAF設定
    - レート制限

## 11. 今後の拡張ポイント

### 11.1 機能拡張
- [ ] ストリーミングレスポンス対応（リアルタイム出力）
- [ ] システムプロンプト設定機能
- [ ] 会話のエクスポート機能
- [ ] 会話の共有機能
- [ ] ファイルアップロード対応

### 11.2 運用・保守
- [ ] DynamoDB TTL設定（古い会話の自動削除）
- [ ] バックアップ設定
- [ ] コスト監視・アラート
- [ ] ユニットテスト・統合テスト
- [ ] CI/CDパイプライン

### 11.3 パフォーマンス
- [ ] Lambda関数のコールドスタート対策
- [ ] DynamoDB GSIの追加最適化
- [ ] Bedrockレスポンスキャッシュ

## 12. ディレクトリ構成（予定）

```
project-root/
├── cdk/
│   ├── app.py                 # CDK アプリエントリーポイント
│   ├── stacks/
│   │   ├── __init__.py
│   │   ├── database_stack.py  # DynamoDB
│   │   ├── auth_stack.py      # Cognito
│   │   ├── api_stack.py       # API Gateway + Lambda
│   │   └── monitoring_stack.py # CloudWatch（Phase 3）
│   └── cdk.json
├── lambda/
│   ├── requirements.txt
│   ├── handler.py             # Lambda エントリーポイント
│   ├── services/
│   │   ├── __init__.py
│   │   ├── bedrock_service.py
│   │   ├── dynamodb_service.py
│   │   └── conversation_service.py
│   └── utils/
│       ├── __init__.py
│       └── response.py
├── tests/                     # Phase 3で追加
│   └── ...
└── README.md
```

## 13. 参考情報

- [AWS CDK Python リファレンス](https://docs.aws.amazon.com/cdk/api/v2/python/)
- [Bedrock Runtime API](https://docs.aws.amazon.com/bedrock/latest/userguide/model-parameters.html)
- [DynamoDB ベストプラクティス](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/best-practices.html)
- [API Gateway Cognito Authorizer](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-integrate-with-cognito.html)

---

**作成日**: 2026-01-15
**バージョン**: 1.0
**ステータス**: Phase 1 実装準備中
